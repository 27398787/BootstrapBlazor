(function(n){function r(t){return this.each(function(){var u=n(this),r=u.data(i.DATA_KEY),f=typeof t=="object"&&t;r||u.data(i.DATA_KEY,r=new i(this,f));typeof t=="string"&&/Reset/.test(t)&&r.resetall.apply(r)})}var i=function(t,i){this.$element=n(t);this.options=n.extend({},i);this.init()},t;i.VERSION="3.1.0";i.Author="argo@163.com";i.DATA_KEY="lgb.Uploader";t=i.prototype;t.init=function(){var t=this;this.$fileItem=this.$element.find(".upload-list .upload-list-item:first");this.$file=this.$element.find(":file");this.showProgress=this.$element.hasClass("is-progress");this.prev=this.$element.hasClass("is-prev");this.iscircle=this.$element.hasClass("is-circle");this.iswall=this.$element.hasClass("is-wall");this.iscard=this.$element.hasClass("is-card");this.isstack=this.$element.hasClass("is-stack");this.url=this.$element.attr("data-url");this.multiple=this.$element.find(":file").attr("multiple")==="multiple";this.files=[];(this.iswall||this.multiple)&&(this.$item=this.$element.find(".upload-prev:first").clone());this.$element.on("click",".upload-prev",function(){t.$element.hasClass("is-disabled")||t.isstack||n(this).hasClass("is-upload")||n(this).hasClass("is-uploading")||(t.$prev=n(this),t.$file.trigger("click"))});this.$element.on("click",".btn-upload",function(){t.$element.hasClass("is-disabled")||(t.isstack?t.$file.trigger("click"):n.each(t.files,function(){t.upload(this.file,this.$prev)}),t.files=[])});this.$element.on("click",".upload-prev .upload-item-delete, .upload-prev .btn-delete",function(i){if(!t.$element.hasClass("is-disabled")){var r=n(this).parents(".upload-prev"),u=r.attr("data-file");r.hasClass("is-invalid-file")?r.remove():n.ajax({url:t.url,method:"delete",data:JSON.stringify(u),contentType:"application/json",dataType:"json",success:function(n){if(n){t.reset.call(t,r);var i=t.options.remoteObj;i.obj.invokeMethodAsync(i.del,u)}},error:function(){t.failed(i,r,{name:u})}})}});this.$file.on("change",function(){t.fileSelected.call(t)});this.url||(this.url="api/Upload")};t.reset=function(n){this.iswall||this.multiple?n.remove():(n.find("img").removeClass("d-block"),n.find(".fa-plus").removeClass("d-none"),n.removeClass("is-upload is-invalid is-valid is-load is-file"),n.removeAttr("data-file"),n.find(".upload-prev-progress-cur").css({width:"0"}),n.find(".upload-prev-progress-text").html("0 %"),this.iscircle&&this.toggleCircle(n,!1))};t.resetall=function(){if(this.iswall||this.multiple)this.$element.find(".upload-body .upload-prev.is-load, .upload-body .upload-prev.is-file").remove();else{var n=this.$element.find(".upload-body .upload-prev");n.find("img").removeClass("d-block");n.find(".fa-plus").removeClass("d-none");n.removeClass("is-upload is-invalid is-valid is-load is-file");n.removeAttr("data-file");n.find(".upload-prev-progress-cur").css({width:"0"});n.find(".upload-prev-progress-text").html("0 %");this.iscircle&&this.toggleCircle(n,!1)}};t.fileSelected=function(){var t=this,i;this.$file[0].files.length!==0&&(i=this.isstack?this.$item.clone():this.$prev,this.isstack&&i.addClass("d-flex").insertAfter(this.$element.find(".upload-prev:first")),n.each(this.$file[0].files,function(n){var u=t.options.remoteObj,r=this;u.obj.invokeMethodAsync(u.check,r.name,r.type,r.size).then(function(u){var f,e;u.result?(i.addClass("is-active").removeClass("is-invalid is-valid").tooltip("dispose"),t.iscircle&&t.toggleCircle(i,!0),t.prevFile.call(t,r,i),t.setUploadItem.call(t,r,i),t.prev?(f=i.attr("data-file"),f&&(e=t.files.findIndex(function(n){return n.file.name===f}),e>-1&&t.files.splice(e,1)),i.attr("data-file",r.name),t.files.push({file:r,$prev:i})):t.upload(r,i),(t.iswall||t.multiple)&&(i=t.$item.clone(),t.isstack?n+1<t.$file[0].files.length&&i.addClass("d-flex").insertAfter(t.$element.find(".upload-prev:first")):i.insertAfter(t.$element.find(".upload-prev:last")))):t.isstack?(i.addClass("is-invalid is-invalid-file"),i.find(".upload-prev-invalid-file .file-name").html(r.name),i.find(".upload-prev-invalid-file .file-error").html(u.message)):(i.removeClass("is-upload is-active").addClass("is-invalid"),t.showError(i,u.message))})}))};t.prevFile=function(n,t){var i,r;n.type.startsWith("image")?(i=new FileReader,i.onloadend=function(n){t.removeClass("is-active").addClass("is-load").find("img").attr("src",n.target.result)},i.readAsDataURL(n)):(t.addClass("is-file"),r=t.find(".upload-file-icon"),r.html(""),r.append(this.createIcon(n.type)))};t.createIcon=function(t){var i=n('<i class="fa"><\/fa>');return t==="application/x-zip-compressed"?i.addClass("fa-file-archive-o"):t==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"?i.addClass("fa-file-word-o"):t==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"?i.addClass("fa-file-excel-o"):t==="application/vnd.openxmlformats-officedocument.presentationml.presentation"?i.addClass("fa-file-powerpoint-o"):t.startsWith("audio")?i.addClass("fa-file-audio-o"):t.startsWith("video")?i.addClass("fa-file-video-o"):t==="application/pdf"?i.addClass("fa-file-pdf-o"):i.addClass("fa-file-text-o"),i};t.showError=function(n,t){n.attr("data-original-title",t);n.attr("data-container","body");n.tooltip("show")};t.setUploadItem=function(n,t){if(n){var i=0;i=n.size>1048576?(Math.round(n.size*100/1048576)/100).toString()+"MB":(Math.round(n.size*100/1024)/100).toString()+"KB";t.find(".upload-list-item-text").text(n.name);t.find(".upload-list-item-size").text(i)}};t.calcSize=function(n){return n>1048576?(Math.round(n*100/1048576)/100).toString()+" MB":(Math.round(n*100/1024)/100).toString()+" KB"};t.progress=function(n,t){var i,r,u,f;n.lengthComputable&&(i=Math.round(n.loaded*100/n.total),this.iscircle?(r=t.find(".upload-item-circle-progress"),r.attr("stroke-dashoffset","0"),u=parseFloat(r.attr("data-dash")),f=i*u/100,r.attr("stroke-dasharray",f+","+u)):this.showProgress&&(t.find(".upload-prev-progress-text").html(i+" %"),t.find(".upload-prev-progress-cur").css({width:i+"%"}),this.calcRate(n.loaded,n.total,t)))};t.calcRate=function(n,t,i){var e=i.find(".upload-list-item-rate"),r,u,f;t>1048576&&(this.ticks||(this.ticks=(new Date).getTime()),r=(new Date).getTime()-this.ticks,r===0&&(r=1),u=n*1e3/r,f=this.calcSize(u),e.html(f+"/s"))};t.toggleCircle=function(n,t){var u=n.find(".upload-item-circle"),i,r;t?u.removeClass("d-none"):(u.addClass("d-none"),i=n.find(".upload-item-circle-progress"),r=parseFloat(i.attr("data-dash")),i.attr("stroke-dashoffset",r),i.attr("stroke-dasharray",r+","+r))};t.toggleLabel=function(n,t){var i=n.find(".upload-item-label");t?i.removeClass("d-none"):i.addClass("d-none")};t.complete=function(t,i,r){var u=this,e=!0,f;try{f=JSON.parse(t.target.response);n.isArray(f)&&(n.each(f,function(t,f){if(f.originFileName==r.name&&(i.addClass("is-upload is-valid"),i.removeClass("is-invalid is-uploading"),i.hasClass("is-file")||i.find("img").attr("src",f.prevUrl+"?v="+n.getUID()),i.attr("data-file",f.fileName),u.options.remoteObj.obj.invokeMethodAsync(u.options.remoteObj.complete,r.name,f.prevUrl)),u.iscard){var e=u.calcSize(r.size);i.find(".upload-list-item-size").html("("+e+")")}}),e=!1)}catch(o){console.log(o)}e&&this.failed(t,i,r)};t.failed=function(n,t,i){t.addClass("is-invalid");var r=this.options.remoteObj;r.obj.invokeMethodAsync(r.failed,i.name);this.showError(t,"服务器端错误上传失败")};t.cancel=function(){alert("The upload has been canceled by the user or the browser dropped the connection.")};t.upload=function(t,i){var r=this,f=new FormData,u,e;f.append(t.name,t);u=new XMLHttpRequest;(this.showProgress||this.iscircle)&&u.upload.addEventListener("progress",function(n){r.progress.call(r,n,i)});u.addEventListener("error",function(n){r.failed.call(r,n,i,t)});u.addEventListener("abort",function(n){r.cancel.call(r,n,i,t)});u.addEventListener("load",function(n){r.complete.call(r,n,i,t)});u.open("POST",this.url);e=this.options.remoteObj.setHeaders;this.options.remoteObj.obj.invokeMethodAsync(e).then(function(t){n.isArray(t)&&n.each(t,function(){u.setRequestHeader(this.name,this.value)});u.send(f);i.removeClass("is-active").addClass("is-uploading")})};n.fn.uploader=r;n.fn.uploader.Constructor=i})(jQuery);